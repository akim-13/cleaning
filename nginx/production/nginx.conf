# Redirect all HTTP traffic to HTTPS
server {
    listen 80;  # Listen for HTTP requests
    server_name clean-check.ru www.clean-check.ru;

    # Redirect all requests to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }

    # Serve Let's Encrypt ACME challenge files for SSL certificate validation.
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}

# HTTPS server block
server {
    # Listen for HTTPS requests on port 443.
    listen 443 ssl http2; 
    server_name clean-check.ru www.clean-check.ru;

    # SSL certificate files generated by Certbot (Let's Encrypt).
    ssl_certificate /etc/letsencrypt/live/clean-check.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/clean-check.ru/privkey.pem;

    # SSL options for security
    ssl_protocols TLSv1.2 TLSv1.3;  # Only use the latest SSL/TLS protocol versions.
    ssl_ciphers HIGH:!aNULL:!MD5;   # Don't use weak ciphers.
    ssl_prefer_server_ciphers on;   # Use server ciphers over the client ones.

    # Match https://clean-check.ru/static/... requests to serve static files.
    location /static/ {
        alias /var/www/static/;  # Maps /static/ requests to /var/www/static/ directory
    }

    # Match https://clean-check.ru/media/... requests to serve media files.
    location /media/ {
        alias /var/www/media/;  # Maps /media/ requests to /var/www/media/ directory
    }

    # Match all other requests and proxy them to Django (Daphne).
    location / {
        proxy_pass http://django:8000;                                # Forward requests to Django container running on port 8000
        proxy_set_header Host $host;                                  # Pass original host header
        proxy_set_header X-Real-IP $remote_addr;                      # Pass clientâ€™s real IP address
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Handle multiple proxies
        proxy_set_header X-Forwarded-Proto $scheme;                   # Pass original HTTP/HTTPS protocol
        proxy_http_version 1.1;                                       # Use HTTP 1.1 for WebSocket support
        proxy_set_header Upgrade $http_upgrade;                       # Allow WebSocket upgrades
        proxy_set_header Connection "upgrade";                        # Handle WebSocket connections
    }
}
